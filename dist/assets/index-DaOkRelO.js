import{r as n,j as t,K as z,u as E}from"./index-7FYdZ7LW.js";import{u as L}from"./useTitle-I86CEnKF.js";import{a as k,S as I}from"./index-UIRDH5-G.js";import{c as S}from"./react--KxBXeKu.js";import{A as B}from"./index-BSXIkSq4.js";import"./ArrowLeft-DLpVywrw.js";const W=async(e=1)=>{try{const a=(await k.get("/images",{params:{page:e},timeout:5e3})).data;return a.code===0?a.data:{images:[],hasMore:!1}}catch(o){return console.error("获取图片失败:",o),{images:[],hasMore:!1}}},N=S((e,o)=>({images:[],page:1,loading:!1,hasMore:!0,fetchMore:async()=>{if(!(o().loading||!o().hasMore)){e({loading:!0});try{const a=await W(o().page);e(r=>({images:[...r.images,...a.images],page:r.page+1,hasMore:a.hasMore,loading:!1}))}catch{e({loading:!1})}}},initialize:async()=>{e({images:[],page:1,loading:!1,hasMore:!0}),await o().fetchMore()}})),R="_container_ayt2q_3",H="_waterfallWrapper_ayt2q_23",q="_column_ayt2q_39",$="_noMore_ayt2q_57",p={container:R,waterfallWrapper:H,column:q,noMore:$},T="_card_1uzfg_1",A="_imageContainer_1uzfg_17",F="_image_1uzfg_17",K="_placeholder_1uzfg_37",Q="_loaded_1uzfg_55",D="_content_1uzfg_63",O="_caption_1uzfg_71",P="_meta_1uzfg_93",Y="_date_1uzfg_107",G="_tags_1uzfg_123",J="_tag_1uzfg_123",U="_mood_1uzfg_151",l={card:T,imageContainer:A,image:F,placeholder:K,loaded:Q,content:D,caption:O,meta:P,date:Y,tags:G,tag:J,mood:U},C=({image:e})=>{const[o,a]=n.useState(!1),r=n.useRef(null),i=n.useRef(null),d=n.useCallback(()=>a(!0),[]);return n.useEffect(()=>{if(!r.current)return;i.current&&i.current.disconnect();const c=new IntersectionObserver(([u])=>{if(u.isIntersecting){const s=new Image;s.src=e.url,s.onload=d,c.unobserve(u.target)}},{rootMargin:"200px 0px",threshold:.01});return c.observe(r.current),i.current=c,()=>c.disconnect()},[e.url,d]),t.jsxs("div",{ref:r,className:l.card,children:[t.jsx("div",{className:l.imageContainer,style:{minHeight:`${e.height/75}rem`},children:o?t.jsx("img",{src:e.url,alt:e.caption,className:`${l.image} ${l.loaded}`,loading:"lazy",decoding:"async"}):t.jsx("div",{className:l.placeholder})}),t.jsxs("div",{className:l.content,children:[t.jsx("p",{className:l.caption,children:e.caption}),t.jsxs("div",{className:l.meta,children:[t.jsxs("div",{className:l.date,children:[e.date,t.jsx("div",{className:l.tags,children:e.tags.map(c=>t.jsxs("span",{className:l.tag,children:["#",c]},c))})]}),t.jsx("span",{className:l.mood,children:e.mood})]})]})]})},V=()=>{const{images:e,loading:o,hasMore:a,fetchMore:r}=N(),[i,d]=n.useState([]),[c,u]=n.useState([]);return n.useEffect(()=>{const s=[...i],m=[...c],g=h=>h.reduce((j,v)=>j+v.height,0);e.slice(i.length+c.length).forEach(h=>{g(s)<=g(m)?s.push(h):m.push(h)}),d(s),u(m)},[e]),n.useEffect(()=>{let s=!1;const m=()=>{!s&&!o&&a&&(window.requestAnimationFrame(()=>{window.innerHeight+window.scrollY>=document.body.offsetHeight-500&&r(),s=!1}),s=!0)};return window.addEventListener("scroll",m),()=>window.removeEventListener("scroll",m)},[o,a,r]),n.useEffect(()=>{e.length===0&&r()},[r,e.length]),t.jsxs("div",{className:p.container,children:[t.jsxs("div",{className:p.waterfallWrapper,children:[t.jsx("div",{className:p.column,children:i.map(s=>t.jsx(C,{image:s},s.id))}),t.jsx("div",{className:p.column,children:c.map(s=>t.jsx(C,{image:s},s.id))})]}),o&&t.jsx(z,{}),!a&&e.length>0&&t.jsx("div",{className:p.noMore,children:"没有更多内容啦～"})]})},X="_container_173ge_23",Z="_diaryButton_173ge_57",ee="_buttonIcon_173ge_93",te="_searchBoxWrapper_173ge_103",_={container:X,diaryButton:Z,buttonIcon:ee,searchBoxWrapper:te},le=()=>{L("Kitty小屋");const{images:e,loading:o,fetchMore:a,hasMore:r,error:i}=N(),[d,c]=n.useState(""),u=E(),s=n.useRef(null),m=n.useCallback((f,x)=>(...w)=>{s.current||(s.current=setTimeout(()=>{f(...w),s.current=null},x))},[]),g=n.useCallback(m(()=>{window.innerHeight+document.documentElement.scrollTop>=document.documentElement.offsetHeight-500&&!o&&r&&a()},300),[o,r,a,m]);n.useEffect(()=>(e.length===0&&!i&&a(),window.addEventListener("scroll",g),()=>{s.current&&clearTimeout(s.current),window.removeEventListener("scroll",g)}),[a,e.length,i,g]);const h=n.useMemo(()=>{if(!d.trim())return e;const f=d.trim().toLowerCase();return e.filter(x=>{var w,y;return((w=x.caption)==null?void 0:w.toLowerCase().includes(f))||((y=x.tags)==null?void 0:y.some(b=>b.toLowerCase().includes(f)))})},[e,d]),j=n.useCallback(()=>{u("/search",{state:{initialQuery:d,shouldFocus:!0}})},[u,d]),v=n.useCallback(f=>{c(f)},[]),M=n.useCallback(()=>{u("/diary")},[u]);return t.jsxs("div",{className:_.container,children:[t.jsx(B,{title:"日记箱"}),t.jsx("div",{onClick:j,className:_.searchBoxWrapper,children:t.jsx(I,{value:d,onChange:v,isSearchPage:!1,shouldAutoFocus:!1})}),i?t.jsxs("div",{className:_.errorMessage,children:["加载失败，请稍后重试",t.jsx("button",{onClick:a,className:_.retryButton,children:"重试"})]}):t.jsx(V,{images:h,loading:o,hasMore:r,fetchMore:a}),t.jsx("button",{className:_.diaryButton,onClick:M,"aria-label":"写日记",children:t.jsx("span",{className:_.buttonIcon,children:"✏️"})})]})};export{le as default};
