import{r as s,j as t,K as C,u as M}from"./index-5URFNoGD.js";import{u as z}from"./useTitle-CQM8J28J.js";import{a as E,S as L}from"./index-BLnrDVNg.js";import{c as I}from"./react-DMxRMRj9.js";import{A as B}from"./index-CH-p-EU2.js";import"./ArrowLeft-BJcQV8kV.js";const R=async(e=1)=>{var a;try{const n=await E.get("/images",{params:{page:e},timeout:5e3});return(n==null?void 0:n.images)||((a=n==null?void 0:n.data)==null?void 0:a.images)||[]}catch(n){return console.error("获取图片失败:",n),[]}},w=I((e,a)=>({images:[],page:1,loading:!1,hasMore:!0,fetchMore:async()=>{if(!(a().loading||!a().hasMore)){e({loading:!0});try{const n=await R(a().page);e(i=>({images:[...i.images,...n],page:i.page+1,hasMore:n.length>0,loading:!1}))}catch{e({loading:!1})}}},initialize:async()=>{e({images:[],page:1,loading:!1,hasMore:!0}),await a().fetchMore()}})),S="_container_12whe_3",T="_waterfall_12whe_13",$="_column_12whe_23",H="_noMore_12whe_47",v={container:S,waterfall:T,column:$,noMore:H},W="_card_ctvzk_1",A="_imageContainer_ctvzk_19",F="_image_ctvzk_19",K="_loaded_ctvzk_57",Q="_content_ctvzk_67",q="_caption_ctvzk_75",O="_meta_ctvzk_97",P="_date_ctvzk_111",D="_tags_ctvzk_127",Y="_tag_ctvzk_127",G="_mood_ctvzk_155",d={card:W,imageContainer:A,image:F,loaded:K,content:Q,caption:q,meta:O,date:P,tags:D,tag:Y,mood:G},J=({image:e,onLike:a})=>{const[n,i]=s.useState(!1),u=s.useRef(null),r=s.useRef(null),o=s.useRef(null),l=s.useCallback(()=>{i(!0)},[]);return s.useEffect(()=>{if(!u.current)return;r.current&&r.current.disconnect(),o.current&&clearTimeout(o.current);const c=new IntersectionObserver(([m])=>{m.isIntersecting&&(o.current=setTimeout(()=>{const h=new Image;h.src=e.url,h.onload=l},300),r.current.unobserve(m.target))},{rootMargin:"200px 0px 200px 0px",threshold:.01});return r.current=c,r.current.observe(u.current),()=>{var m;(m=r.current)==null||m.disconnect(),clearTimeout(o.current)}},[e.url,l]),t.jsxs("div",{ref:u,className:d.card,"aria-labelledby":`caption-${e.id}`,role:"article",children:[t.jsx("div",{className:d.imageContainer,children:n?t.jsx("img",{src:e.url,alt:e.caption,className:`${d.image} ${d.loaded}`,loading:"lazy",decoding:"async"}):t.jsx("div",{className:d.imagePlaceholder})}),t.jsxs("div",{className:d.content,children:[t.jsx("p",{id:`caption-${e.id}`,className:d.caption,children:e.caption}),t.jsxs("div",{className:d.meta,children:[t.jsxs("div",{className:d.date,children:[e.date,t.jsx("div",{className:d.tags,children:e.tags.map(c=>t.jsxs("span",{className:d.tag,children:["#",c]},c))})]}),t.jsx("span",{className:d.mood,children:e.mood})]})]})]})},U=()=>{const{images:e,loading:a,hasMore:n,fetchMore:i}=w(),[u,r]=s.useState(2);return s.useEffect(()=>{const o=()=>{r(2)};return o(),window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[]),s.useEffect(()=>{let o=!1;const l=()=>{!o&&!a&&n&&(window.requestAnimationFrame(()=>{window.innerHeight+window.scrollY>=document.body.offsetHeight-500&&i(),o=!1}),o=!0)};return window.addEventListener("scroll",l),()=>window.removeEventListener("scroll",l)},[a,n,i]),s.useEffect(()=>{e.length===0&&i()},[i,e.length]),t.jsxs("div",{className:v.container,children:[t.jsx("div",{className:v.waterfall,children:Array.from({length:u}).map((o,l)=>t.jsx("div",{className:v.column,children:e.filter((c,m)=>m%u===l).map(c=>t.jsx(J,{image:c},c.id))},l))}),a&&t.jsx(C,{}),!n&&e.length>0&&t.jsx("div",{className:v.noMore,children:"没有更多内容啦～"})]})},V="_container_r3dom_12",X="_diaryButton_r3dom_46",Z="_buttonIcon_r3dom_82",ee="_searchBoxWrapper_r3dom_92",g={container:V,diaryButton:X,buttonIcon:Z,searchBoxWrapper:ee},ce=()=>{z("Kitty小屋");const{images:e,loading:a,fetchMore:n,hasMore:i,error:u}=w(),[r,o]=s.useState(""),l=M(),c=s.useRef(null),m=s.useCallback((f,_)=>(...p)=>{c.current||(c.current=setTimeout(()=>{f(...p),c.current=null},_))},[]),h=s.useCallback(m(()=>{window.innerHeight+document.documentElement.scrollTop>=document.documentElement.offsetHeight-500&&!a&&i&&n()},300),[a,i,n,m]);s.useEffect(()=>(e.length===0&&!u&&n(),window.addEventListener("scroll",h),()=>{c.current&&clearTimeout(c.current),window.removeEventListener("scroll",h)}),[n,e.length,u,h]);const j=s.useMemo(()=>{if(!r.trim())return e;const f=r.trim().toLowerCase();return e.filter(_=>{var p,x;return((p=_.caption)==null?void 0:p.toLowerCase().includes(f))||((x=_.tags)==null?void 0:x.some(N=>N.toLowerCase().includes(f)))})},[e,r]),y=s.useCallback(()=>{l("/search",{state:{initialQuery:r,shouldFocus:!0}})},[l,r]),k=s.useCallback(f=>{o(f)},[]),b=s.useCallback(()=>{l("/diary")},[l]);return t.jsxs("div",{className:g.container,children:[t.jsx(B,{title:"日记箱"}),t.jsx("div",{onClick:y,className:g.searchBoxWrapper,children:t.jsx(L,{value:r,onChange:k,isSearchPage:!1,shouldAutoFocus:!1})}),u?t.jsxs("div",{className:g.errorMessage,children:["加载失败，请稍后重试",t.jsx("button",{onClick:n,className:g.retryButton,children:"重试"})]}):t.jsx(U,{images:j,loading:a,hasMore:i,fetchMore:n}),t.jsx("button",{className:g.diaryButton,onClick:b,"aria-label":"写日记",children:t.jsx("span",{className:g.buttonIcon,children:"✏️"})})]})};export{ce as default};
