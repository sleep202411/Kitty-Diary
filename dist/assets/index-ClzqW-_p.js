import{r as a,j as t,K as C,u as M}from"./index-_8CRas7D.js";import{u as z}from"./useTitle-uU9Zhg01.js";import{a as E,S as L}from"./index-DJ5whZ-l.js";import{c as I}from"./react-BVew-p-W.js";import{A as B}from"./index-C3KWWkDQ.js";import"./ArrowLeft-Cj23IyZF.js";const R=async(e=1)=>{try{const s=(await E.get("/images",{params:{page:e},timeout:5e3})).data;return s.code===0?s.data:{images:[],hasMore:!1}}catch(n){return console.error("获取图片失败:",n),{images:[],hasMore:!1}}},w=I((e,n)=>({images:[],page:1,loading:!1,hasMore:!0,fetchMore:async()=>{if(!(n().loading||!n().hasMore)){e({loading:!0});try{const s=await R(n().page);e(i=>({images:[...i.images,...s.images],page:i.page+1,hasMore:s.hasMore,loading:!1}))}catch{e({loading:!1})}}},initialize:async()=>{e({images:[],page:1,loading:!1,hasMore:!0}),await n().fetchMore()}})),S="_container_12whe_3",T="_waterfall_12whe_13",$="_column_12whe_23",H="_noMore_12whe_47",v={container:S,waterfall:T,column:$,noMore:H},W="_card_ctvzk_1",A="_imageContainer_ctvzk_19",F="_image_ctvzk_19",K="_loaded_ctvzk_57",Q="_content_ctvzk_67",q="_caption_ctvzk_75",O="_meta_ctvzk_97",P="_date_ctvzk_111",D="_tags_ctvzk_127",Y="_tag_ctvzk_127",G="_mood_ctvzk_155",d={card:W,imageContainer:A,image:F,loaded:K,content:Q,caption:q,meta:O,date:P,tags:D,tag:Y,mood:G},J=({image:e,onLike:n})=>{const[s,i]=a.useState(!1),u=a.useRef(null),r=a.useRef(null),o=a.useRef(null),l=a.useCallback(()=>{i(!0)},[]);return a.useEffect(()=>{if(!u.current)return;r.current&&r.current.disconnect(),o.current&&clearTimeout(o.current);const c=new IntersectionObserver(([m])=>{m.isIntersecting&&(o.current=setTimeout(()=>{const h=new Image;h.src=e.url,h.onload=l},300),r.current.unobserve(m.target))},{rootMargin:"200px 0px 200px 0px",threshold:.01});return r.current=c,r.current.observe(u.current),()=>{var m;(m=r.current)==null||m.disconnect(),clearTimeout(o.current)}},[e.url,l]),t.jsxs("div",{ref:u,className:d.card,"aria-labelledby":`caption-${e.id}`,role:"article",children:[t.jsx("div",{className:d.imageContainer,children:s?t.jsx("img",{src:e.url,alt:e.caption,className:`${d.image} ${d.loaded}`,loading:"lazy",decoding:"async"}):t.jsx("div",{className:d.imagePlaceholder})}),t.jsxs("div",{className:d.content,children:[t.jsx("p",{id:`caption-${e.id}`,className:d.caption,children:e.caption}),t.jsxs("div",{className:d.meta,children:[t.jsxs("div",{className:d.date,children:[e.date,t.jsx("div",{className:d.tags,children:e.tags.map(c=>t.jsxs("span",{className:d.tag,children:["#",c]},c))})]}),t.jsx("span",{className:d.mood,children:e.mood})]})]})]})},U=()=>{const{images:e,loading:n,hasMore:s,fetchMore:i}=w(),[u,r]=a.useState(2);return a.useEffect(()=>{const o=()=>{r(2)};return o(),window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[]),a.useEffect(()=>{let o=!1;const l=()=>{!o&&!n&&s&&(window.requestAnimationFrame(()=>{window.innerHeight+window.scrollY>=document.body.offsetHeight-500&&i(),o=!1}),o=!0)};return window.addEventListener("scroll",l),()=>window.removeEventListener("scroll",l)},[n,s,i]),a.useEffect(()=>{e.length===0&&i()},[i,e.length]),t.jsxs("div",{className:v.container,children:[t.jsx("div",{className:v.waterfall,children:Array.from({length:u}).map((o,l)=>t.jsx("div",{className:v.column,children:e.filter((c,m)=>m%u===l).map(c=>t.jsx(J,{image:c},c.id))},l))}),n&&t.jsx(C,{}),!s&&e.length>0&&t.jsx("div",{className:v.noMore,children:"没有更多内容啦～"})]})},V="_container_y7kmn_12",X="_diaryButton_y7kmn_46",Z="_buttonIcon_y7kmn_82",ee="_searchBoxWrapper_y7kmn_92",g={container:V,diaryButton:X,buttonIcon:Z,searchBoxWrapper:ee},ce=()=>{z("Kitty小屋");const{images:e,loading:n,fetchMore:s,hasMore:i,error:u}=w(),[r,o]=a.useState(""),l=M(),c=a.useRef(null),m=a.useCallback((f,_)=>(...p)=>{c.current||(c.current=setTimeout(()=>{f(...p),c.current=null},_))},[]),h=a.useCallback(m(()=>{window.innerHeight+document.documentElement.scrollTop>=document.documentElement.offsetHeight-500&&!n&&i&&s()},300),[n,i,s,m]);a.useEffect(()=>(e.length===0&&!u&&s(),window.addEventListener("scroll",h),()=>{c.current&&clearTimeout(c.current),window.removeEventListener("scroll",h)}),[s,e.length,u,h]);const y=a.useMemo(()=>{if(!r.trim())return e;const f=r.trim().toLowerCase();return e.filter(_=>{var p,x;return((p=_.caption)==null?void 0:p.toLowerCase().includes(f))||((x=_.tags)==null?void 0:x.some(N=>N.toLowerCase().includes(f)))})},[e,r]),j=a.useCallback(()=>{l("/search",{state:{initialQuery:r,shouldFocus:!0}})},[l,r]),k=a.useCallback(f=>{o(f)},[]),b=a.useCallback(()=>{l("/diary")},[l]);return t.jsxs("div",{className:g.container,children:[t.jsx(B,{title:"日记箱"}),t.jsx("div",{onClick:j,className:g.searchBoxWrapper,children:t.jsx(L,{value:r,onChange:k,isSearchPage:!1,shouldAutoFocus:!1})}),u?t.jsxs("div",{className:g.errorMessage,children:["加载失败，请稍后重试",t.jsx("button",{onClick:s,className:g.retryButton,children:"重试"})]}):t.jsx(U,{images:y,loading:n,hasMore:i,fetchMore:s}),t.jsx("button",{className:g.diaryButton,onClick:b,"aria-label":"写日记",children:t.jsx("span",{className:g.buttonIcon,children:"✏️"})})]})};export{ce as default};
